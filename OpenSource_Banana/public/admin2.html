<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…çº§ç®¡ç†å‘˜åå° - ä¿®å¤ç‰ˆ</title>
    <style>
        body { font-family: sans-serif; background: #f3f4f6; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { width: 400px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        input { width: 100%; padding: 15px; margin: 10px 0; border: 1px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; }
        button { width: 100%; padding: 15px; background: #4f46e5; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold; }
        button:hover { background: #4338ca; }
        #msg { margin-top: 15px; color: red; font-size: 14px; min-height: 20px; }
        
        /* åå°è¡¨æ ¼æ ·å¼ */
        #adminPanel { display: none; width: 90%; max-width: 1000px; margin-top: 20px; text-align: left; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #eee; padding: 12px; text-align: left; }
        th { background: #f9fafb; }
    </style>
</head>
<body>

    <!-- 1. ç™»å½•ç•Œé¢ -->
    <div id="loginPanel" class="container">
        <h2>ğŸ›¡ï¸ ç®¡ç†å‘˜ç™»å½•</h2>
        <form onsubmit="handleLogin(event)">
            <input type="email" id="email" placeholder="é‚®ç®±" value="925626799@qq.com" required>
            <input type="password" id="password" placeholder="å¯†ç " required>
            <button type="submit" id="loginBtn">ç™» å½•</button>
        </form>
        <div id="msg"></div>
    </div>

    <!-- 2. åå°ç•Œé¢ -->
    <div id="adminPanel" class="container">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>ğŸš€ ç”¨æˆ·ç®¡ç†</h2>
            <button onclick="location.reload()" style="width:auto; padding:5px 15px; background:#ef4444;">é€€å‡º</button>
        </div>
        <button onclick="fetchUsers()" style="width:auto; margin-bottom:10px;">ğŸ”„ åˆ·æ–°æ•°æ®</button>
        <table id="userTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ç”¨æˆ·</th>
                    <th>é‚®ç®±</th>
                    <th>ç§¯åˆ†</th>
                    <th>è§’è‰²</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // å…¨å±€å˜é‡å­˜ Token
        let authToken = '';

        async function handleLogin(e) {
            e.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤åˆ·æ–°
            
            const btn = document.getElementById('loginBtn');
            const msg = document.getElementById('msg');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            btn.innerText = 'æ­£åœ¨ç™»å½•...';
            btn.disabled = true;
            msg.innerText = '';

            try {
                console.log('å°è¯•ç™»å½•:', email);
                
                const res = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await res.json();
                console.log('æœåŠ¡å™¨è¿”å›:', data);

                if (data.success) {
                    // ç™»å½•æˆåŠŸ
                    msg.innerText = 'ç™»å½•æˆåŠŸï¼æ­£åœ¨è·³è½¬...';
                    msg.style.color = 'green';
                    
                    authToken = data.data.token;
                    
                    // æ£€æŸ¥æƒé™
                    if(data.data.user.role !== 'admin') {
                         msg.innerText = 'ç™»å½•æˆåŠŸï¼Œä½†è¯¥è´¦å·ä¸æ˜¯ç®¡ç†å‘˜ï¼';
                         msg.style.color = 'red';
                         btn.innerText = 'ç™»å½•';
                         btn.disabled = false;
                         return;
                    }

                    // åˆ‡æ¢ç•Œé¢
                    document.getElementById('loginPanel').style.display = 'none';
                    document.getElementById('adminPanel').style.display = 'block';
                    
                    // åŠ è½½æ•°æ®
                    fetchUsers();

                } else {
                    // ç™»å½•å¤±è´¥
                    msg.innerText = 'é”™è¯¯: ' + (data.error || 'æœªçŸ¥é”™è¯¯');
                    btn.innerText = 'ç™»å½•';
                    btn.disabled = false;
                }

            } catch (err) {
                console.error(err);
                msg.innerText = 'ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + err.message;
                btn.innerText = 'ç™»å½•';
                btn.disabled = false;
            }
        }

        async function fetchUsers() {
            try {
                const res = await fetch('/api/admin/users', {
                    headers: { 'Authorization': 'Bearer ' + authToken }
                });
                const data = await res.json();
                
                if(data.success) {
                    const tbody = document.querySelector('#userTable tbody');
                    tbody.innerHTML = data.data.map(u => `
                        <tr>
                            <td>${u.id}</td>
                            <td>${u.username}</td>
                            <td>${u.email}</td>
                            <td>${u.drawing_points}</td>
                            <td>${u.role}</td>
                            <td><button onclick="addPoints(${u.id})" style="width:auto; padding:5px 10px; font-size:12px;">+10åˆ†</button></td>
                        </tr>
                    `).join('');
                } else {
                    alert('åŠ è½½å¤±è´¥: ' + data.error);
                }
            } catch(e) {
                alert('åŠ è½½å‡ºé”™: ' + e.message);
            }
        }
        
        async function addPoints(uid) {
            if(!confirm('ç¡®å®šåŠ åˆ†å—ï¼Ÿ')) return;
            const res = await fetch('/api/admin/users/points', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + authToken 
                },
                body: JSON.stringify({ userId: uid, points: 10 })
            });
            const d = await res.json();
            if(d.success) { alert('æˆåŠŸ'); fetchUsers(); }
            else alert('å¤±è´¥');
        }
    </script>
</body>
</html>
